<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Begin Bridgetown SEO tag v5.0.0 -->
<title>How to use turbo_frame_tag in a custom layout | Juan C. Ruiz</title>
<meta property="og:title" content="How to use turbo_frame_tag in a custom layout" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I am working on a side project using Rails 7 and Hotwire. One of the features I implemented was a modal window which is called using turbo_frame_tag to render the creation form. Everything was going well until I decided to include a custom layout for the logged-in user dashboard." />
<meta property="og:description" content="I am working on a side project using Rails 7 and Hotwire. One of the features I implemented was a modal window which is called using turbo_frame_tag to render the creation form. Everything was going well until I decided to include a custom layout for the logged-in user dashboard." />
<link rel="canonical" href="/posts/how-to-use-turbo-frame-tag-in-a-custom-layout" />
<meta property="og:url" content="/posts/how-to-use-turbo-frame-tag-in-a-custom-layout" />
<meta property="og:site_name" content="Juan C. Ruiz" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-06-11T05:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="How to use turbo_frame_tag in a custom layout" />
<!-- End Bridgetown SEO tag -->


<link href="https://fonts.googleapis.com/css?family=Raleway:400,700" rel="stylesheet" />
<link rel="stylesheet" href="/_bridgetown/static/css/main.2d02f55dc6fc19703e21.css" />
<script src="/_bridgetown/static/js/main.0811b103c2b1181ddec3.js" defer></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-56736524-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-56736524-1');
</script>



  </head>
  <body class="post ">
    <nav>
  <ul>
    <li>
      <a href="/">Home</a>
    </li>
    <li>
      <a href="/about">About</a>
    </li>
    <li>
      <a href="/posts">Posts</a>
    </li>
  </ul>
</nav>


    <main>
      <div class="post">
  <h1>How to use turbo_frame_tag in a custom layout</h1>

  <p>I am working on a side project using Rails 7 and Hotwire. One of the features I implemented was a modal window which is called using <code class="highlighter-rouge">turbo_frame_tag</code> to render the creation form. Everything was going well until I decided to include a custom layout for the logged-in user dashboard.</p>

<h2 id="tldr">TLDR;</h2>

<p>Do not load the layout statically using <code class="highlighter-rouge">layout 'custom_layout'</code>. Instead, use a method that checks if the request is a <code class="highlighter-rouge">turbo_frame_tag</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo::ApplicationController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="n">layout</span> <span class="ss">:set_custom_layout_with_turbo_frame_support</span>

<span class="kp">private</span>

  <span class="k">def</span> <span class="nf">set_custom_layout_with_turbo_frame_support</span>
    <span class="k">return</span> <span class="s1">'custom_layout'</span> <span class="k">unless</span> <span class="n">turbo_frame_request?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="the-problem">The problem</h2>

<p>Initially, the logic to load the modal window was composed of 3 elements:</p>

<p>A call to the <code class="highlighter-rouge">turbo_frame_tag</code> in the base layout that contains my Rails application:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/views/layouts/application.html.erb</span>
<span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="sx">%= render "shared/alerts" %&gt;
  &lt;main class=</span><span class="s2">"container mx-auto mt-28 px-5 flex"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="sx">%= turbo_frame_tag "modal" %&gt;
    &lt;%=</span> <span class="k">yield</span> <span class="sx">%&gt;
  &lt;/main&gt;</span>
<span class="o">&lt;</span><span class="sr">/body&gt;
</span></code></pre></div></div>

<p>A view that contains the content of the frame representing the modal:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/views/elements/new.html.erb</span>
<span class="o">&lt;</span><span class="sx">%= turbo_frame_tag "modal" do %&gt;
  &lt;div class=</span><span class="s2">"modal modal-open"</span><span class="p">,</span> <span class="n">data</span><span class="o">-</span><span class="n">controller</span><span class="o">=</span><span class="s2">"turbo-modal"</span><span class="p">,</span> <span class="n">data</span><span class="o">-</span><span class="n">action</span><span class="o">=</span><span class="s2">"..."</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">%= form_with(model: @element, url: element_path, class: 'modal-box') do |form| %&gt;
      My form content
    &lt;% end %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</span></code></pre></div></div>

<p>And finally a call to the turbo frame using a data attribute:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="sx">%= link_to 'Create Element', new_element_path, class: 'link link-hover', data: { turbo_frame: 'modal' } %&gt;
</span></code></pre></div></div>

<p>By default, this generates the <code class="highlighter-rouge">turbo-frame</code> and renders it in my application using the properties of <code class="highlighter-rouge">turbo-rails</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">turbo</span><span class="o">-</span><span class="n">frame</span> <span class="nb">id</span><span class="o">=</span><span class="s2">"modal"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">div</span> <span class="k">class</span><span class="o">=</span><span class="s2">"modal modal-open"</span><span class="p">,</span>
       <span class="n">data</span><span class="o">-</span><span class="n">controller</span><span class="o">=</span><span class="s2">"turbo-modal"</span><span class="p">,</span>
       <span class="n">data</span><span class="o">-</span><span class="n">action</span><span class="o">=</span><span class="s2">"...."</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">form</span> <span class="k">class</span><span class="o">=</span><span class="s2">"modal-box"</span> <span class="n">action</span><span class="o">=</span><span class="s2">"/elements"</span> <span class="n">accept</span><span class="o">-</span><span class="n">charset</span><span class="o">=</span><span class="s2">"UTF-8"</span> <span class="nb">method</span><span class="o">=</span><span class="s2">"post"</span><span class="o">&gt;&lt;</span><span class="n">input</span> <span class="n">type</span><span class="o">=</span><span class="s2">"hidden"</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"authenticity_token"</span> <span class="n">value</span><span class="o">=</span><span class="s2">"xyz"</span> <span class="n">autocomplete</span><span class="o">=</span><span class="s2">"off"</span> <span class="o">/&gt;</span>
      <span class="no">My</span> <span class="n">form</span> <span class="n">content</span>
    <span class="o">&lt;</span><span class="sr">/form&gt;
    &lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/turbo-frame&gt;
</span></code></pre></div></div>

<p>The problem started when I created a new identical layout within the layouts directory and set it as the default layout within the <code class="highlighter-rouge">ApplicationController</code> of my namespace.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo::ApplicationController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">layout</span> <span class="s1">'custom_layout'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Immediately upon doing this, when I clicked on the link that calls the turbo frame, instead of retrieving <code class="highlighter-rouge">&lt;turbo-frame id="modal"&gt;</code> as the response of the request, I started receiving the entire layout as the response. This caused the native <code class="highlighter-rouge">turbo-rails</code> action to stop working:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;!</span><span class="no">DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span> <span class="n">data</span><span class="o">-</span><span class="n">theme</span><span class="o">=</span><span class="s2">"light"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="no">Foo</span><span class="o">&lt;</span><span class="sr">/title&gt;
    &lt;meta name="viewport" content="width=device-width,initial-scale=1"&gt;
    &lt;meta name="csrf-param" content="authenticity_token" /</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"csrf-token"</span> <span class="n">content</span><span class="o">=</span><span class="s2">"5QJ-_2XaOHFTaNKEJkLcjOTewSbJ03QMjp6yeVABCkHaP94Uc4la6GnGtxIRp6LmoXAwbpixj657sYrc3ir2Mg"</span> <span class="o">/&gt;</span>


    <span class="o">&lt;</span><span class="n">link</span> <span class="n">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/assets/tailwind-24d55e02196000307cecef67bba818aa60975a400a31c502e1ad9c155bd7b147.css"</span> <span class="n">data</span><span class="o">-</span><span class="n">turbo</span><span class="o">-</span><span class="n">track</span><span class="o">=</span><span class="s2">"reload"</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">link</span> <span class="n">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/assets/inter-font-8c3e82affb176f4bca9616b838d906343d1251adc8408efe02cf2b1e4fcf2bc4.css"</span> <span class="n">data</span><span class="o">-</span><span class="n">turbo</span><span class="o">-</span><span class="n">track</span><span class="o">=</span><span class="s2">"reload"</span> <span class="o">/&gt;</span>

    <span class="o">&lt;</span><span class="n">link</span> <span class="n">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/assets/application-186311012c4e733c61b267717a8abc6092b57cc4ba1b125e36e9c3fc2c3b8e30.css"</span> <span class="n">data</span><span class="o">-</span><span class="n">turbo</span><span class="o">-</span><span class="n">track</span><span class="o">=</span><span class="s2">"reload"</span> <span class="o">/&gt;</span>
</code></pre></div></div>

<h2 id="the-solution">The solution</h2>

<p>After researching for a while and ending up on this <a href="https://github.com/hotwired/turbo-rails/issues/268">issue reported in 2021</a> in the <a href="https://github.com/hotwired/turbo-rails">hotwired/turbo-rails</a> repository, I found that the solution is to check if the request is classified as <code class="highlighter-rouge">turbo_frame_request?</code> and if so, return <code class="highlighter-rouge">false</code> to prevent the response from including the custom layout we added. If you’re curious about how this <code class="highlighter-rouge">turbo_frame_request?</code> method works, you can check it out <a href="https://github.com/hotwired/turbo-rails/blob/ea00f3732e21af9c2156cf74dabe95524b17c361/app/controllers/turbo/frames/frame_request.rb">at this link</a>. Essentially, we’re checking if the request contains the <code class="highlighter-rouge">Turbo-Frame</code> header.</p>

<p>The solution can be as follows</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo::ApplicationController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="n">layout</span> <span class="ss">:set_custom_layout_with_turbo_frame_support</span>

<span class="kp">private</span>

  <span class="k">def</span> <span class="nf">set_custom_layout_with_turbo_frame_support</span>
    <span class="k">return</span> <span class="s1">'custom_layout'</span> <span class="k">unless</span> <span class="n">turbo_frame_request?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>On <a href="https://github.com/hotwired/turbo-rails/pull/470">June 5 2023 a Pull request was opened</a> adding a section to the readme to explain this situation and how to solve it, in order to avoid having to navigate through issues to find a way to address this problem.</p>

</div>

    </main>
  </body>
</html>

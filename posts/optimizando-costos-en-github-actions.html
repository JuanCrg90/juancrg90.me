<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Begin Bridgetown SEO tag v5.0.0 -->
<title>Optimizando costos en GitHub Actions | Juan C. Ruiz</title>
<meta property="og:title" content="Optimizando costos en GitHub Actions" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="English version" />
<meta property="og:description" content="English version" />
<link rel="canonical" href="/posts/optimizando-costos-en-github-actions" />
<meta property="og:url" content="/posts/optimizando-costos-en-github-actions" />
<meta property="og:site_name" content="Juan C. Ruiz" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-30T05:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Optimizando costos en GitHub Actions" />
<!-- End Bridgetown SEO tag -->


<link href="https://fonts.googleapis.com/css?family=Raleway:400,700" rel="stylesheet" />
<link rel="stylesheet" href="/_bridgetown/static/css/main.2d02f55dc6fc19703e21.css" />
<script src="/_bridgetown/static/js/main.0811b103c2b1181ddec3.js" defer></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-56736524-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-56736524-1');
</script>



  </head>
  <body class="post ">
    <nav>
  <ul>
    <li>
      <a href="/">Home</a>
    </li>
    <li>
      <a href="/about">About</a>
    </li>
    <li>
      <a href="/posts">Posts</a>
    </li>
  </ul>
</nav>


    <main>
      <div class="post">
  <h1>Optimizando costos en GitHub Actions</h1>

  <p><a href="/posts/optimizing-costs-in-github-actions">English version</a></p>

<p>Recientemente en <a href="https://www.easybroker.com/">EasyBroker</a> migramos nuestro sistema de Integraci√≥n continua a GitHub Actions.</p>

<p>Inicialmente configuramos un Workflow con 12 contenedores considerando que era una buena idea para identificar r√°pidamente donde fallaron las pruebas.</p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892644/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_e9sjqq.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled.png" /></p>

<p>En promedio cada contenedor tardaba 6 minutos en completar su tarea, mientras que 2 contenedores en espec√≠fico (modelos y un grupo de controladores) tardaban en promedio 12 minutos.
<img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892643/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_1_rbxmvb.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%201.png" /></p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892643/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_2_oornut.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%202.png" /></p>

<p>Despu√©s de una semana trabajando con esta nueva implementaci√≥n recibimos un mensaje de GitHub alert√°ndonos que est√°bamos por llegar al l√≠mite de uso de la capa gratuita que GitHub nos provee üí∏üí∏üí∏, por lo que decidimos investigar.</p>

<p>En primer lugar notamos que de los 6 minutos que tardaban los 10 contenedores m√°s r√°pidos, en promedio 4 minutos eran tareas de configuraci√≥n.</p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892643/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_3_ryutfn.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%203.png" /></p>

<p>Posteriormente notamos que a pesar de tener el cache ‚Äúconfigurado‚Äù, nuestro contenedor estaba descargando las gemas una y otra vez.</p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892644/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_4_mkohr1.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%204.png" /></p>

<p>Y finalmente solo se invert√≠an entre 20 y 50 segundos en ejecutar las pruebas.</p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892644/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_5_dhlisu.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%205.png" /></p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892643/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_6_u1saes.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%206.png" /></p>

<h2 id="ahorr√°ndonos-unos-minutos">Ahorr√°ndonos unos minutos</h2>

<p>Lo primero que decidimos hacer fue pasar de 12 contenedores a 2 contenedores. Considerando que las pruebas de los controladores de agentes son las que toman m√°s tiempo, decidimos que lo modelos pod√≠an convivir con las pruebas de los 10 contenedores que tardaban 6 minutos en promedio, terminando con una configuraci√≥n como la siguiente.</p>

<p>Antes</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">strategy</span><span class="pi">:</span>
      <span class="na">fail-fast</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">test_folder</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">models</span><span class="pi">,</span> <span class="nv">helpers</span><span class="pi">,</span> <span class="nv">jobs</span><span class="pi">,</span> <span class="nv">lib</span><span class="pi">,</span> <span class="nv">mailers</span><span class="pi">,</span> <span class="nv">presenters</span><span class="pi">,</span> <span class="nv">services</span><span class="pi">,</span> <span class="nv">controllers/*.rb</span><span class="pi">,</span> <span class="nv">controllers/admin</span><span class="pi">,</span> <span class="nv">controllers/agent</span><span class="pi">,</span> <span class="nv">controllers/webhooks</span><span class="pi">,</span> <span class="nv">controllers/api</span><span class="pi">]</span>
</code></pre></div></div>

<p>Ahora</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">strategy</span><span class="pi">:</span>
      <span class="na">fail-fast</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">test_folder</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">models helpers test/jobs test/lib test/mailers test/presenters test/services test/controllers/*.rb test/controllers/admin test/controllers/webhooks testcontrollers/api</span><span class="pi">,</span> <span class="nv">controllers/agent</span><span class="pi">]</span>

</code></pre></div></div>

<p>Lo siguiente fue actualizar el apartado de cache para hacerlo funcionar, nuestra configuraci√≥n utilizaba la versi√≥n 1 de actions/cache e inclu√≠a la opci√≥n de restore-keys la cual seg√∫n la documentaci√≥n es <a href="https://github.com/actions/cache#inputs">opcional</a>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Gem cache</span>
        <span class="s">uses</span><span class="err">:</span> <span class="s">actions/cache@v1</span>
        <span class="s">with</span><span class="err">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">vendor/bundle</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">$-gems-$</span>
          <span class="na">restore-keys</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">$-gems-</span>
</code></pre></div></div>

<p>Por lo que simplemente actualic√© a la versi√≥n 2 de la acci√≥n y remov√≠ la opci√≥n de restore-keys al considerar que no es algo que requerimos a√∫n.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Gem cache</span>
        <span class="s">uses</span><span class="err">:</span> <span class="s">actions/cache@v2</span>
        <span class="s">with</span><span class="err">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">vendor/bundle</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">$-gem-use-ruby-$</span>
</code></pre></div></div>

<p>Adem√°s de eso, revisando el paso donde se instalan las dependencias, encontr√© que lo ten√≠amos fusionado con el paso para crear la base de datos y nos mostraba un deprecation warning al momento de ejecutar bundle install  con la bandera para indicar la ruta de instalaci√≥n de las gemas.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Bundle Install and Create DB</span>
        <span class="s">env</span><span class="err">:</span>
          <span class="na">RAILS_ENV</span><span class="pi">:</span> <span class="s">test</span>
          <span class="na">DB_PASSWORD</span><span class="pi">:</span> <span class="s">root</span>
          <span class="na">DB_PORT</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo /etc/init.d/mysql start</span>
          <span class="s">cp config/database.ci.yml config/database.yml</span>
          <span class="s">gem install bundler --version 2.0.2 --no-ri --no-rdoc</span>
          <span class="s">bundle install --jobs 4 --retry 3 --path vendor/bundle</span>
          <span class="s">bin/rails db:setup</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>DEPRECATED] The <span class="sb">`</span><span class="nt">--path</span><span class="sb">`</span> flag is deprecated because it relies on being remembered across bundler invocations, which bundler will no longer <span class="k">do in </span>future versions. Instead please use <span class="sb">`</span>bundle config <span class="nb">set </span>path <span class="s1">'vendor/bundle'</span><span class="sb">`</span>, and stop using this flag
</code></pre></div></div>

<p>Por lo que opt√© por separarlo en 2 pasos independientes y actualizar la forma en la que bundler detecta la ubicaci√≥n de las gemas.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Bundle install</span>
        <span class="s">run</span><span class="err">:</span> <span class="pi">|</span>
          <span class="s">gem install bundler --version 2.0.2 --no-ri --no-rdoc</span>
          <span class="s">bundle config path vendor/bundle</span>
          <span class="s">bundle install --jobs 4 --retry 3</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create DB</span>
        <span class="s">env</span><span class="err">:</span>
          <span class="na">RAILS_ENV</span><span class="pi">:</span> <span class="s">test</span>
          <span class="na">DB_PASSWORD</span><span class="pi">:</span> <span class="s">root</span>
          <span class="na">DB_PORT</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo /etc/init.d/mysql start</span>
          <span class="s">cp config/database.ci.yml config/database.yml</span>
          <span class="s">bin/rails db:setup</span>
</code></pre></div></div>

<p>Con estos peque√±os cambios logramos pasar de  4 minutos en la instalaci√≥n de las gemas a tan solo 4 segundos.</p>

<p>Antes</p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892644/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_7_tawvjy.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%207.png" /></p>

<p>Ahora</p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892644/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_8_dyhwlj.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%208.png" /></p>

<p>Como paso final para esta primer etapa de optimizaci√≥n, revis√© los pasos d√≥nde realiz√°bamos la instalaci√≥n de algunas dependencias por apt-get y encontr√© que algunos eran innecesarios. Por ejemplo, cuando verific√°bamos la conexi√≥n a MySQL, est√°bamos tratando de instalar el cliente que ya est√° disponible y esto tomaba 20 segundos en promedio (entre verificar la instalaci√≥n y verificar que la conexi√≥n fue exitosa) con solo remover la llamada de apt-get que no era necesario logramos bajar a un promedio de 6 segundos.</p>

<p>Antes</p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892645/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_9_odbx1j.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%209.png" /></p>

<p>Ahora</p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892644/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_10_s1uik1.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%2010.png" /></p>

<h2 id="notas-finales">Notas finales</h2>

<p>Esta fue la primer etapa de nuestra actualizaci√≥n para tener un sistema de integraci√≥n continua saludable y eficiente, logramos pasar de un promedio de 1 hora 30 minutos por ejecuci√≥n.</p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892644/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_11_tt7ewa.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%2011.png" /></p>

<p>A tan solo 20 minutos en promedio.</p>

<p><img src="https://res.cloudinary.com/juancrg90/image/upload/v1590892644/Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled_12_kifcvl.png" alt="Optimizing%20costs%20in%20GitHub%20Actions%207b464c031286482f9b1db7b6d9b72442/Untitled%2012.png" /></p>

<p>Como experiencia nos llevamos que, en servicios donde la factura es por tiempo de uso, el ahorrar segundos es crucial y es importante poner atenci√≥n a los detalles por peque√±os que sean. Como en el caso de la instalaci√≥n de dependencias que ya existen en el contenedor. Puede que 13 segundos ahorrados suene a nada, pero si lo multiplicamos por el n√∫mero de builds que tiene tu empresa al d√≠a, puede que logres ahorrar un par de horas en tu factura.</p>

<p>Lo siguiente que haremos ser√° tratar de mover la instalaci√≥n de dependencias que requieren ser instaladas manualmente a un contenedor Docker (a√∫n necesito investigar si es posible esto) y utilizar alguna herramienta como <a href="https://evilmartians.com/chronicles/testprof-a-good-doctor-for-slow-ruby-tests">TestProf</a> para identificar los tests m√°s lentos y ver la manera de optimizarlos.</p>

</div>

    </main>
  </body>
</html>
